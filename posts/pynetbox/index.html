<!DOCTYPE html>





















<html class="not-ready text-sm lg:text-base" lang="en-us">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>Generating a dynamic host inventory for ansible with Netbox - Memo Garcia</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="Usage:
pip install pynetbox ansible ansible all -i hosts/env -m setup --tree /tmp/facts/env #!/opt/netbox/bin/python import argparse import json import os import sys import pynetbox import yaml import urllib3 urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) if sys.version_info &lt; (3, 6): print(&#34;Python 3.6 is required&#34;) sys.exit(2) def to_json(in_dict): return json.dumps(in_dict, sort_keys=True, indent=4) def load_configuration(path=&#34;/etc/ansible/netbox.yml&#34;): &#34;&#34;&#34; Load netbox configuration /etc/ansible/netbox.yml &#34;&#34;&#34; try: with open(path, &#34;r&#34;) as fd: return yaml.safe_load(fd) except yaml.YAMLError as yml_error: print(yml_error) NETBOX_ENDPOINT = load_configuration()[&#34;netbox_endpoint&#34;] NETBOX_TOKEN = load_configuration()[&#34;netbox_token&#34;] if not NETBOX_ENDPOINT: raise OSError(&#34;environmet var NETBOX_ENDPOINT not set&#34;) if not NETBOX_TOKEN: raise OSError(&#34;environmet var NETBOX_TOKEN not set&#34;) nb = pynetbox." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://memooo.ooo/main.min.css" />

  
  <script defer src="https://memooo.ooo/highlight.min.js" onload="hljs.initHighlightingOnLoad();"></script>
  

  
  
  
  

  
  <link rel="preload" as="image" href="https://memooo.ooo/github.svg" />
  

  

  
  <meta name="generator" content="Hugo 0.101.0" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="Generating a dynamic host inventory for ansible with Netbox" />
<meta property="og:description" content="Usage:
pip install pynetbox ansible ansible all -i hosts/env -m setup --tree /tmp/facts/env #!/opt/netbox/bin/python import argparse import json import os import sys import pynetbox import yaml import urllib3 urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) if sys.version_info &lt; (3, 6): print(&#34;Python 3.6 is required&#34;) sys.exit(2) def to_json(in_dict): return json.dumps(in_dict, sort_keys=True, indent=4) def load_configuration(path=&#34;/etc/ansible/netbox.yml&#34;): &#34;&#34;&#34; Load netbox configuration /etc/ansible/netbox.yml &#34;&#34;&#34; try: with open(path, &#34;r&#34;) as fd: return yaml.safe_load(fd) except yaml.YAMLError as yml_error: print(yml_error) NETBOX_ENDPOINT = load_configuration()[&#34;netbox_endpoint&#34;] NETBOX_TOKEN = load_configuration()[&#34;netbox_token&#34;] if not NETBOX_ENDPOINT: raise OSError(&#34;environmet var NETBOX_ENDPOINT not set&#34;) if not NETBOX_TOKEN: raise OSError(&#34;environmet var NETBOX_TOKEN not set&#34;) nb = pynetbox." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://memooo.ooo/posts/pynetbox/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-10T23:30:44+01:00" />
<meta property="article:modified_time" content="2019-01-10T23:30:44+01:00" />


  
  <meta itemprop="name" content="Generating a dynamic host inventory for ansible with Netbox">
<meta itemprop="description" content="Usage:
pip install pynetbox ansible ansible all -i hosts/env -m setup --tree /tmp/facts/env #!/opt/netbox/bin/python import argparse import json import os import sys import pynetbox import yaml import urllib3 urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) if sys.version_info &lt; (3, 6): print(&#34;Python 3.6 is required&#34;) sys.exit(2) def to_json(in_dict): return json.dumps(in_dict, sort_keys=True, indent=4) def load_configuration(path=&#34;/etc/ansible/netbox.yml&#34;): &#34;&#34;&#34; Load netbox configuration /etc/ansible/netbox.yml &#34;&#34;&#34; try: with open(path, &#34;r&#34;) as fd: return yaml.safe_load(fd) except yaml.YAMLError as yml_error: print(yml_error) NETBOX_ENDPOINT = load_configuration()[&#34;netbox_endpoint&#34;] NETBOX_TOKEN = load_configuration()[&#34;netbox_token&#34;] if not NETBOX_ENDPOINT: raise OSError(&#34;environmet var NETBOX_ENDPOINT not set&#34;) if not NETBOX_TOKEN: raise OSError(&#34;environmet var NETBOX_TOKEN not set&#34;) nb = pynetbox."><meta itemprop="datePublished" content="2019-01-10T23:30:44+01:00" />
<meta itemprop="dateModified" content="2019-01-10T23:30:44+01:00" />
<meta itemprop="wordCount" content="566">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Generating a dynamic host inventory for ansible with Netbox"/>
<meta name="twitter:description" content="Usage:
pip install pynetbox ansible ansible all -i hosts/env -m setup --tree /tmp/facts/env #!/opt/netbox/bin/python import argparse import json import os import sys import pynetbox import yaml import urllib3 urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning) if sys.version_info &lt; (3, 6): print(&#34;Python 3.6 is required&#34;) sys.exit(2) def to_json(in_dict): return json.dumps(in_dict, sort_keys=True, indent=4) def load_configuration(path=&#34;/etc/ansible/netbox.yml&#34;): &#34;&#34;&#34; Load netbox configuration /etc/ansible/netbox.yml &#34;&#34;&#34; try: with open(path, &#34;r&#34;) as fd: return yaml.safe_load(fd) except yaml.YAMLError as yml_error: print(yml_error) NETBOX_ENDPOINT = load_configuration()[&#34;netbox_endpoint&#34;] NETBOX_TOKEN = load_configuration()[&#34;netbox_token&#34;] if not NETBOX_ENDPOINT: raise OSError(&#34;environmet var NETBOX_ENDPOINT not set&#34;) if not NETBOX_TOKEN: raise OSError(&#34;environmet var NETBOX_TOKEN not set&#34;) nb = pynetbox."/>

  
  
</head>
  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://memooo.ooo/">Memo Garcia</a>
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"></a>

  <script>
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const htmlClass = document.documentElement.classList;
    requestAnimationFrame(() => {
      htmlClass.remove('not-ready');
    });

    const setDark = (newDark) => {
      metaTheme.setAttribute('content', newDark ? '#000' : '#FCFAF9');
      htmlClass[newDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', newDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none">
    
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a class="block font-medium lg:font-normal text-center leading-[5rem] text-3xl lg:text-base "
        href="/about/">About</a>
      
    </nav>
    
    

    
    <nav class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6">
      
      
      <a class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/memogarcia "
        target="_blank"></a>
      
      
    </nav>
    
    
  </div>
</header>

    <main
      class="prose prose-zinc relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-16 pb-40 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2">Generating a dynamic host inventory for ansible with Netbox</h1>

    
    <div class="text-[0.9em] text-zinc-500">
      
      <time>Jan 10, 2019</time>
      
      
    </div>
    
  </header>

  <section><p>Usage:</p>
<pre><code>pip install pynetbox ansible

ansible all -i hosts/env -m setup --tree /tmp/facts/env
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/opt/netbox/bin/python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pynetbox
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib3
</span></span><span style="display:flex;"><span>urllib3<span style="color:#f92672">.</span>disable_warnings(urllib3<span style="color:#f92672">.</span>exceptions<span style="color:#f92672">.</span>InsecureRequestWarning)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>version_info <span style="color:#f92672">&lt;</span> (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">6</span>):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Python 3.6 is required&#34;</span>)
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_json</span>(in_dict):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>dumps(in_dict, sort_keys<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_configuration</span>(path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/ansible/netbox.yml&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Load netbox configuration
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        /etc/ansible/netbox.yml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> fd:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> yaml<span style="color:#f92672">.</span>safe_load(fd)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> yaml<span style="color:#f92672">.</span>YAMLError <span style="color:#66d9ef">as</span> yml_error:
</span></span><span style="display:flex;"><span>        print(yml_error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NETBOX_ENDPOINT <span style="color:#f92672">=</span> load_configuration()[<span style="color:#e6db74">&#34;netbox_endpoint&#34;</span>]
</span></span><span style="display:flex;"><span>NETBOX_TOKEN <span style="color:#f92672">=</span> load_configuration()[<span style="color:#e6db74">&#34;netbox_token&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> NETBOX_ENDPOINT:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">OSError</span>(<span style="color:#e6db74">&#34;environmet var NETBOX_ENDPOINT not set&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> NETBOX_TOKEN:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">OSError</span>(<span style="color:#e6db74">&#34;environmet var NETBOX_TOKEN not set&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nb <span style="color:#f92672">=</span> pynetbox<span style="color:#f92672">.</span>api(NETBOX_ENDPOINT, NETBOX_TOKEN, ssl_verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_args</span>():
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser()
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--list&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--host&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store&#39;</span>)
</span></span><span style="display:flex;"><span>    parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--introspection&#39;</span>, action<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;store_true&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_site</span>(site_name):
</span></span><span style="display:flex;"><span>    site <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>sites<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span>site_name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> site
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_vms</span>(site_name):
</span></span><span style="display:flex;"><span>    platform <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>platforms<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span>site_name)
</span></span><span style="display:flex;"><span>    vms <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>virtualization<span style="color:#f92672">.</span>virtual_machines<span style="color:#f92672">.</span>filter(platform_id<span style="color:#f92672">=</span>platform<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> vms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_devices</span>(site_name):
</span></span><span style="display:flex;"><span>    platform <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>platforms<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span>site_name)
</span></span><span style="display:flex;"><span>    devices <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>devices<span style="color:#f92672">.</span>filter(platform_id<span style="color:#f92672">=</span>platform<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> devices
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_roles</span>():
</span></span><span style="display:flex;"><span>    roles <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>device_roles<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> roles
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_role</span>(server):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> server<span style="color:#f92672">.</span>role
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> server<span style="color:#f92672">.</span>device_role
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> error:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ungrouped&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">which_tenant</span>(server):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> server<span style="color:#f92672">.</span>tenant:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> str(server<span style="color:#f92672">.</span>tenant)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># print(&#34;No tenant&#34;)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> error:
</span></span><span style="display:flex;"><span>        print(error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">which_gmn</span>(server):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;management&#34;</span> <span style="color:#f92672">in</span> server<span style="color:#f92672">.</span>tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;management&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;no_management&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> error:
</span></span><span style="display:flex;"><span>        print(error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tenants</span>():
</span></span><span style="display:flex;"><span>    tenants <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>tenancy<span style="color:#f92672">.</span>tenants<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tenants
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_device_role</span>(site, role_name):
</span></span><span style="display:flex;"><span>    platform <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>platforms<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span>site)
</span></span><span style="display:flex;"><span>    role <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>device_roles<span style="color:#f92672">.</span>get(platform_id<span style="color:#f92672">=</span>platform<span style="color:#f92672">.</span>id, name<span style="color:#f92672">=</span>role_name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> role:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Role not found&#34;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> role<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_vip</span>(site, servers):
</span></span><span style="display:flex;"><span>    vms <span style="color:#f92672">=</span> get_vms(site)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    proxy_vms <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> vm <span style="color:#f92672">in</span> vms:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> str(vm<span style="color:#f92672">.</span>role)<span style="color:#f92672">.</span>lower() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;proxy-servers&#34;</span>:
</span></span><span style="display:flex;"><span>            proxy_vms<span style="color:#f92672">.</span>append(vm)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> vm <span style="color:#f92672">in</span> proxy_vms:
</span></span><span style="display:flex;"><span>        ips <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>ipam<span style="color:#f92672">.</span>ip_addresses<span style="color:#f92672">.</span>filter(virtual_machine_id<span style="color:#f92672">=</span>vm<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> ip <span style="color:#f92672">in</span> ips:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> str(ip<span style="color:#f92672">.</span>role) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;VIP&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> ip<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_tenant_role_map</span>(path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/ansible/role-tenant-map.json&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(path, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> fd:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>load(fd)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> error:
</span></span><span style="display:flex;"><span>        print(error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_inventory</span>(site, servers):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34; Generate ansible groups based on roles and tenants
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    role_tenant_map <span style="color:#f92672">=</span> get_tenant_role_map()
</span></span><span style="display:flex;"><span>    roles <span style="color:#f92672">=</span> get_roles()
</span></span><span style="display:flex;"><span>    tenants <span style="color:#f92672">=</span> get_tenants()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># base json|yaml structure</span>
</span></span><span style="display:flex;"><span>    inventory <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;all&#34;</span>: {<span style="color:#e6db74">&#34;hosts&#34;</span>: []},
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;management&#34;</span>: {<span style="color:#e6db74">&#34;children&#34;</span>: {}},
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;no_management&#34;</span>: {<span style="color:#e6db74">&#34;children&#34;</span>: {}, <span style="color:#e6db74">&#34;vars&#34;</span>: {}},
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ungrouped&#34;</span>: {<span style="color:#e6db74">&#34;children&#34;</span>: {}},
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;_meta&#34;</span>: {<span style="color:#e6db74">&#34;hostvars&#34;</span>: {}}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    proxy_vip <span style="color:#f92672">=</span> get_vip(site, servers)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> proxy_vip:
</span></span><span style="display:flex;"><span>        inventory[<span style="color:#e6db74">&#34;no_gmn&#34;</span>][<span style="color:#e6db74">&#34;vars&#34;</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ansible_ssh_common_args&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#39;-o ProxyJump=</span><span style="color:#e6db74">{</span>proxy_vip<span style="color:#e6db74">}</span><span style="color:#e6db74"> -o StrictHostKeyChecking=no&#39;&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> tenant <span style="color:#f92672">in</span> tenants:
</span></span><span style="display:flex;"><span>        inventory[tenant<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;children&#34;</span>: {}}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> role <span style="color:#f92672">in</span> role_tenant_map[tenant<span style="color:#f92672">.</span>name]:
</span></span><span style="display:flex;"><span>            inventory[tenant<span style="color:#f92672">.</span>name][<span style="color:#e6db74">&#34;children&#34;</span>][role] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> role <span style="color:#f92672">in</span> roles:
</span></span><span style="display:flex;"><span>        inventory[role<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;hosts&#34;</span>: []}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> role<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;proxy-servers&#34;</span>:
</span></span><span style="display:flex;"><span>            inventory[<span style="color:#e6db74">&#34;management&#34;</span>][<span style="color:#e6db74">&#34;children&#34;</span>][role<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            inventory[<span style="color:#e6db74">&#34;no_management&#34;</span>][<span style="color:#e6db74">&#34;children&#34;</span>][role<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> server <span style="color:#f92672">in</span> servers:
</span></span><span style="display:flex;"><span>        ip <span style="color:#f92672">=</span> str(server<span style="color:#f92672">.</span>primary_ip)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        role <span style="color:#f92672">=</span> str(get_role(server))
</span></span><span style="display:flex;"><span>        inventory[<span style="color:#e6db74">&#34;all&#34;</span>][<span style="color:#e6db74">&#34;hosts&#34;</span>]<span style="color:#f92672">.</span>append(server<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>        inventory[<span style="color:#e6db74">&#34;_meta&#34;</span>][<span style="color:#e6db74">&#34;hostvars&#34;</span>][server<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ansible_host&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>ip<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> role <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;None&#34;</span>:
</span></span><span style="display:flex;"><span>            inventory[role][<span style="color:#e6db74">&#34;hosts&#34;</span>]<span style="color:#f92672">.</span>append(server<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> to_json(inventory)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_introspection_data</span>(site_name):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    site_name: str: SITE1, SITE2, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return list(dicts)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;mac&#34;: &#34;pxe mac&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;arch&#34;: &#34;x86_64&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;pm_type&#34;: &#34;pxe_ilo&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;pm_user&#34;: &#34;static per site&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;pm_password&#34;: &#34;static per site&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;pm_address&#34;: &#34;IPMI address&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            &#34;name&#34;: &#34;position name&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    steps:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        query devices api on a given site (platform) for computes and controllers
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        get pm_user and pm_password from somewhere
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        get IPMI address
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    openstack_nodes <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    platform <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>platforms<span style="color:#f92672">.</span>get(name<span style="color:#f92672">=</span>site_name)
</span></span><span style="display:flex;"><span>    devices <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>devices<span style="color:#f92672">.</span>filter(platform_id<span style="color:#f92672">=</span>platform<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> device <span style="color:#f92672">in</span> devices:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> device<span style="color:#f92672">.</span>custom_fields[<span style="color:#e6db74">&#34;openstack_device&#34;</span>]:
</span></span><span style="display:flex;"><span>            d <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;name&#34;</span>: device<span style="color:#f92672">.</span>name,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;mac&#34;</span>: [device<span style="color:#f92672">.</span>custom_fields[<span style="color:#e6db74">&#34;openstack_pxeboot_mac&#34;</span>]],
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;pm_type&#34;</span>: <span style="color:#e6db74">&#34;pxe_ilo&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arch&#34;</span>: <span style="color:#e6db74">&#34;x86_64&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;pm_user&#34;</span>: os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;OS_INTROSPECTION_USER&#34;</span>, <span style="color:#66d9ef">None</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;pm_password&#34;</span>: os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;OS_INTROSPECTION_PASSWORD&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            interfaces <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>dcim<span style="color:#f92672">.</span>interfaces<span style="color:#f92672">.</span>filter(device_id<span style="color:#f92672">=</span>device<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> interfaces:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> i<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ILO&#34;</span>:
</span></span><span style="display:flex;"><span>                    ilo_ip <span style="color:#f92672">=</span> nb<span style="color:#f92672">.</span>ipam<span style="color:#f92672">.</span>ip_addresses<span style="color:#f92672">.</span>filter(interface_id<span style="color:#f92672">=</span>i<span style="color:#f92672">.</span>id)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>                    d[<span style="color:#e6db74">&#34;pm_address&#34;</span>] <span style="color:#f92672">=</span> ilo_ip<span style="color:#f92672">.</span>address<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>            openstack_nodes<span style="color:#f92672">.</span>append(d)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> to_json(openstack_nodes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parse_args()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Are &#34;-&#34; deprecated in group names?</span>
</span></span><span style="display:flex;"><span>    site_name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;SITE&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> site_name:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Define a site to query with SITE environment variable&#34;</span>)
</span></span><span style="display:flex;"><span>        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    site_name <span style="color:#f92672">=</span> site_name<span style="color:#f92672">.</span>upper()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>introspection:
</span></span><span style="display:flex;"><span>        introspection_data <span style="color:#f92672">=</span> get_introspection_data(site_name)
</span></span><span style="display:flex;"><span>        print(introspection_data)
</span></span><span style="display:flex;"><span>        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    devices <span style="color:#f92672">=</span> get_devices(site_name)
</span></span><span style="display:flex;"><span>    vms <span style="color:#f92672">=</span> get_vms(site_name)
</span></span><span style="display:flex;"><span>    servers <span style="color:#f92672">=</span> devices <span style="color:#f92672">+</span> vms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>list:
</span></span><span style="display:flex;"><span>        hosts <span style="color:#f92672">=</span> generate_inventory(site_name, servers)
</span></span><span style="display:flex;"><span>        print(hosts)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> args<span style="color:#f92672">.</span>host:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div></section>

  
  

  
  
  
  <nav class="mt-16 flex rounded-lg bg-zinc-100 text-lg dark:bg-zinc-800">
    
    <a class="flex w-1/2 items-center p-6 pr-3 font-bold no-underline" href="https://memooo.ooo/posts/doc-fzf/"
      ><span class="mr-1.5">←</span><span>Modular CLI Documentation Fuzzy Finder</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 font-bold no-underline"
      href="https://memooo.ooo/posts/richard-feynman/"
      ><span>Some Richard Feynman videos</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
</article>


    </main>

    
  </body>
</html>
